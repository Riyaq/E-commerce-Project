import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import mysql.connector


# To establish connection taing a variable as mydb.
mydb = mysql.connector.connect(host="localhost", 
                               username="root",
                               password="Riya",
                               database="ecommerce")

# Lets activate the cursor.
cur = mydb.cursor()
----------------------------------------------------------------------------------------------------------------------
1. Query:List all unique cities where customer are located.

```sql
select distinct customer_city from customers;
```
----------------------------------------------------------------------------------------------------------------------
2. Query: Count the number of orders placed in 2017

Code-
select count(order_id) from orders where year(order_purchase_timestamp)=2017;
----------------------------------------------------------------------------------------------------------------------
3. Find the total sale per category

Products --> Product_category , Product_id
Payments --> Payment_value , order_id
Order_itmes --> Product_id , order_id

```sql
SELECT products.product_category category, round(sum(payments.payment_value),2)  sales
from products
join order_items
on 
products.Product_id=order_items.Product_id
join payments
on payments.order_id=order_items.order_id
group by category;
```
----------------------------------------------------------------------------------------------------------------------
4. Calculate total percentage of orders that were paid in installments.

```sql
SELECT (sum(case when payment_installments>=1 then 1 else 0 end))/count(*)*100 from payments
```

----------------------------------------------------------------------------------------------------------------------
5. Count the number of customer from each state
```sql
SELECT customer_state, count(customer_id) from  oldcustomers group by customer_state;"""
```


# Using matploblib here

import matplotlib.pyplot as plt
query = """ SELECT customer_state, count(customer_id) from  oldcustomers group by customer_state; """
cur.execute(query)
data = cur.fetchall()
df=pd.DataFrame(data, columns = ["State","Customer_count"])
df=df.sort_values(by= "Customer_count", ascending=False)
plt.figure(figsize=(8,3))
plt.bar(df["State"],df["Customer_count"])
plt.xticks(rotation=90)
plt.show()



----------------------------------------------------------------------------------------------------------------------

6. Calculate number of orders per month in the year 2018
```sql
Select monthname(order_purchase_timestamp) month, count(order_id) order_count from orders
where year(order_purchase_timestamp) = 2018
group by month;
```
# USING BAR GRAPH
plt.bar(df["Month"],df["Order_count"])
plt.show()


----------------------------------------------------------------------------------------------------------------------
7. Find the average number of products per order, grouped by customer city.

oldcustomers table -> Customer_id , Customer_city
order_items table -> order_id , Order_item_id
orders table -> order_id , Customer_id



# Creating a table to store output of first query named as - count_per_order
code-
with count_per_order as 
(select orders.order_id, orders.customer_id, count(order_items.order_id) as oc
from orders join order_items
on orders.order_id = order_items.order_id
group by orders.order_id, orders.customer_id)

select oldcustomers.customer_city, round(avg(count_per_order.oc),2) average_orders
from oldcustomers join count_per_order
on oldcustomers.customer_id = count_per_order.customer_id
group by oldcustomers.customer_city order by average_orders desc

----------------------------------------------------------------------------------------------------------------------
8. Calculate the percentage of total revenue contributed by each product category.

Payments table -> order_id , payment_value
Products table -> product_id , product_category
order_items table -> order_id ,product_id

I need two row -> Product_category , Revenue_distribution

SELECT upper(products.product_category) category, round((sum(payments.payment_value)/(select sum(Payment_value) from Payments))*100,2)  percentage_distribution
from products
join order_items
on 
products.Product_id=order_items.Product_id
join payments
on payments.order_id=order_items.order_id
group by category order by percentage_distribution desc ;


----------------------------------------------------------------------------------------------------------------------

9. Calculate the total revenue generated by each seller, and rank them by revenue.


Payments table -> order_id , payment_value
Sellers table -> Seller_id
order_items table -> order_id ,Seller_id

select Sellers.Seller_id , round(sum(payments.payment_value),2) Revenue
from payments join order_items
on payments.order_id=order_items.order_id
join Sellers 
on Sellers.Seller_id=order_items.Seller_id
group by Seller_id order by Revenue desc;


